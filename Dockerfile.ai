# Use Python 3.9 Alpine image with AI support
FROM python:3.9-alpine

# Set working directory
WORKDIR /app

# Install system dependencies (Alpine packages)
RUN apk add --no-cache \
    libgcc \
    libstdc++ \
    libgomp \
    musl \
    wget \
    curl \
    gcc \
    g++ \
    make \
    cmake \
    linux-headers \
    pkgconfig \
    python3-dev \
    fftw-dev \
    lapack-dev \
    gfortran \
    openblas-dev

# Copy requirements first for better caching
COPY railway_requirements_fixed.txt requirements.txt

# Install Python dependencies with CPU-only PyTorch
RUN pip install --no-cache-dir --upgrade pip \
    && pip install --no-cache-dir torch==2.0.1+cpu torchvision==0.15.2+cpu --index-url https://download.pytorch.org/whl/cpu \
    && pip install --no-cache-dir -r requirements.txt \
    && pip cache purge

# Copy application code
COPY railway_app.py .

# Download YOLO model (smaller version)
RUN wget -O yolov8n.pt https://github.com/ultralytics/assets/releases/download/v0.0.0/yolov8n.pt

# Create uploads directory
RUN mkdir -p /app/uploads

# Expose port
EXPOSE 8000

# Run the application
CMD ["python", "railway_app.py"]
